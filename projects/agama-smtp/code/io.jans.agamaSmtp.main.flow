Flow io.jans.agamaSmtp.main
     Basepath ""
     Timeout 360 seconds
     Configs conf
     Inputs emailHint
Log "@debug Email authentication started"
obj = { email: emailHint, captureLocation: conf.captureLocation }
obj = RRF "main.ftlh" obj
email = obj.email
userData = Call io.jans.agamasmtp.IdentityProcessor#accountFromEmail email
// attach contextual data
emailUnknown = userData.empty
userData.context = { location: obj.location, timeZone: obj.zone, device: obj.device }
When emailUnknown is true
     obj = Trigger io.jans.agamaSmtp.emailVerification email false userData.context
     When obj.success is true
          Log "@info E-mail verification passed, initiating user provisioning flow"
          obj = { email: email }
          obj = Trigger io.jans.agamaSmtp.registration obj
          When obj.success is true
               userData = obj.data
               msg = [ userData.name, ", your account has been created!" ]
               msg = Call java.lang.String#join "" msg
               obj.user = userData.name
               obj.email = email
               obj = RRF "acknowledgement.ftlh" obj
               When obj.ack is ""
                    uid = userData.uid
                    it_wtldl = {success:true, data: { userId: uid}}
                    Finish it_wtldl
               obj = { success : false}
               it_mreld = {success:true, data: { userId: "as9233Qz", obj: obj}}
               Finish it_mreld
Log "@info User with e-mail % is known" email
obj = Trigger io.jans.agamaSmtp.emailVerification email false userData.context
When obj.success is true
     uid = userData.uid
     it_ytrgm = {success:true, data: { userId: "as9233Qz", uid: uid}}
     Finish it_ytrgm