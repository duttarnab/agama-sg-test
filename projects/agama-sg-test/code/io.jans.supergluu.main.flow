Flow io.jans.supergluu.main
     Basepath ""
     Configs conf
Log "@info Identity agama-passkey started"
authService = Call io.jans.as.server.service.AuthenticationService#class
cdiUtil = Call io.jans.service.cdi.util.CdiUtil#bean authService
loginResponse = {}
Repeat 3 times max
     loginResponse = RRF "main.ftlh" loginResponse
     loginResponse.success = Call cdiUtil authenticate loginResponse.username loginResponse.password
     loginResponse.uid = loginResponse.username
     When loginResponse.success is true
          userData = Call io.jans.agamapasskey.IdentityProcessor#accountFromUid loginResponse.uid
          obj = Trigger io.jans.supergluu.credsEnrollment userData obj.data.mfaInfo
          When obj.success is true
               Log "@trace Auth success!"
               When obj.data.hadEnoughCreds is false
                    it_jwqxz = { success: true, data: { userId: loginResponse.uid } }
                    Finish it_jwqxz
               obj = Trigger io.jans.supergluu.authenticator userData obj.data.mfaInfo
               When obj.success is true
                    it_akkuz = { success: true, data: { userId: loginResponse.uid } }
                    Finish it_akkuz
          it_eakvo = { success: true, data: { userId: obj } }
          Finish it_eakvo
it_arfdj = { success: false, error: "Your error message here" }
Finish it_arfdj